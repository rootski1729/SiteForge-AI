{% extends "base.html" %}

{% block title %}My Websites - AI Website Builder{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1>My Websites </h1>
            <a href="/create-website" class="btn btn-success">
                Create New Website
            </a>
        </div>
        
        <div id="websitesContainer">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading your websites...</p>
            </div>
        </div>
    </div>
</div>

<!-- Edit Website Modal -->
<div id="editModal" class="modal hidden">
    <div class="modal-content">
        <h2>Edit Website</h2>
        <form id="editWebsiteForm">
            <input type="hidden" id="editWebsiteId">
            
            <div class="form-group">
                <label for="editTitle">Website Title</label>
                <input type="text" id="editTitle" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="editPublished">Status</label>
                <select id="editPublished" name="is_published">
                    <option value="false">Draft (Not visible to public)</option>
                    <option value="true">Published (Live website)</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                <button type="button" onclick="closeEditModal()" class="btn">Cancel</button>
                <button type="submit" class="btn btn-success">Save Changes</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.status-badge {
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.8em;
    font-weight: bold;
}

.status-published {
    background: #d4edda;
    color: #155724;
}

.status-draft {
    background: #fff3cd;
    color: #856404;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    let websites = [];
    
    async function loadWebsites() {
        try {
            const result = await apiCall('/api/websites');
            websites = result.websites || [];
            displayWebsites();
        } catch (error) {
            document.getElementById('websitesContainer').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #e74c3c;">
                    <p>Error loading websites: ${error.message}</p>
                </div>
            `;
        }
    }
    
    function displayWebsites() {
        const container = document.getElementById('websitesContainer');
        
        if (websites.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #666;">
                    <h3>No websites yet</h3>
                    <p>Create your first AI-powered website to get started!</p>
                    <a href="/create-website" class="btn btn-primary" style="margin-top: 20px;">
                        üöÄ Create First Website
                    </a>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <div class="grid">
                ${websites.map(website => `
                    <div class="website-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <h3>${website.title}</h3>
                            <span class="status-badge ${website.is_published ? 'status-published' : 'status-draft'}">
                                ${website.is_published ? 'üü¢ Live' : 'üü° Draft'}
                            </span>
                        </div>
                        
                        <div class="website-meta">
                            <p><strong>Type:</strong> ${website.business_type || 'General'}</p>
                            <p><strong>Industry:</strong> ${website.industry || 'N/A'}</p>
                            <p><strong>Created:</strong> ${new Date(website.created_at).toLocaleDateString()}</p>
                            <p><strong>Last Updated:</strong> ${new Date(website.updated_at).toLocaleDateString()}</p>
                        </div>
                        
                        <div class="website-actions">
                            ${website.is_published ? 
                                `<a href="/api/preview/${website._id}" target="_blank" class="btn btn-success">üëÅÔ∏è View Live</a>` : 
                                '<span class="btn" style="opacity: 0.5; cursor: not-allowed;">üëÅÔ∏è Not Published</span>'
                            }
                            <button onclick="editWebsite('${website._id}')" class="btn btn-primary">‚úèÔ∏è Edit</button>
                            <button onclick="regenerateContent('${website._id}')" class="btn" style="background: #f39c12;">üîÑ Regenerate</button>
                            <button onclick="deleteWebsite('${website._id}')" class="btn btn-danger">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    function editWebsite(websiteId) {
        const website = websites.find(w => w._id === websiteId);
        if (!website) return;
        
        document.getElementById('editWebsiteId').value = websiteId;
        document.getElementById('editTitle').value = website.title;
        document.getElementById('editPublished').value = website.is_published.toString();
        
        document.getElementById('editModal').classList.remove('hidden');
    }
    
    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }
    
    async function regenerateContent(websiteId) {
        if (!confirm('Are you sure you want to regenerate the content? This will replace all current content.')) {
            return;
        }
        
        try {
            showLoading('websitesContainer');
            await apiCall(`/api/regenerate-content/${websiteId}`, 'POST');
            showAlert('Content regenerated successfully!', 'success');
            loadWebsites();
        } catch (error) {
            showAlert(error.message, 'error');
            loadWebsites();
        }
    }
    
    async function deleteWebsite(websiteId) {
        if (!confirm('Are you sure you want to delete this website? This action cannot be undone.')) {
            return;
        }
        
        try {
            await apiCall(`/api/websites/${websiteId}`, 'DELETE');
            showAlert('Website deleted successfully!', 'success');
            loadWebsites();
        } catch (error) {
            showAlert(error.message, 'error');
        }
    }
    
    // Edit form submission
    document.getElementById('editWebsiteForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const websiteId = document.getElementById('editWebsiteId').value;
        const formData = new FormData(e.target);
        
        const data = {
            title: formData.get('title'),
            is_published: formData.get('is_published') === 'true'
        };
        
        try {
            await apiCall(`/api/websites/${websiteId}`, 'PUT', data);
            showAlert('Website updated successfully!', 'success');
            closeEditModal();
            loadWebsites();
        } catch (error) {
            showAlert(error.message, 'error');
        }
    });
    
    // Close modal when clicking outside
    document.getElementById('editModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEditModal();
        }
    });
    
    // Load websites on page load
    document.addEventListener('DOMContentLoaded', loadWebsites);
</script>
{% endblock %}