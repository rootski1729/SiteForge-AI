{% extends "base.html" %}

{% block title %}My Websites - AI Website Builder{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1>My Websites üì±</h1>
            <a href="/create-website" class="btn btn-success">
                ‚ûï Create New Website
            </a>
        </div>
        
        <div id="websitesContainer">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading your websites...</p>
            </div>
        </div>
    </div>
</div>

<!-- Edit Website Modal - ONLY opens when Edit button is clicked -->
<div id="editModal" class="modal hidden">
    <div class="modal-content">
        <h2>Edit Website</h2>
        <form id="editWebsiteForm">
            <input type="hidden" id="editWebsiteId">
            
            <div class="form-group">
                <label for="editTitle">Website Title</label>
                <input type="text" id="editTitle" name="title" required>
                <small style="color: #666;">ID: <span id="currentWebsiteId"></span></small>
            </div>
            
            <div class="form-group">
                <label for="editPublished">Status</label>
                <select id="editPublished" name="is_published">
                    <option value="false">Draft (Not visible to public)</option>
                    <option value="true">Published (Live website)</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                <button type="button" onclick="closeEditModal()" class="btn">Cancel</button>
                <button type="submit" class="btn btn-success">Save Changes</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.status-badge {
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.8em;
    font-weight: bold;
}

.status-published {
    background: #d4edda;
    color: #155724;
}

.status-draft {
    background: #fff3cd;
    color: #856404;
}

.website-card {
    cursor: default; /* Prevent cursor change */
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    let websites = [];
    
    async function loadWebsites() {
        try {
            console.log('Loading websites...');
            
            const authToken = localStorage.getItem('auth_token');
            if (!authToken) {
                showError('Please login first');
                return;
            }
            
            const response = await fetch('/api/websites', {
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const result = await response.json();
            websites = result.websites || [];
            console.log('Websites loaded:', websites.length);
            
            displayWebsites();
            
        } catch (error) {
            console.error('Error loading websites:', error);
            showError('Failed to load websites: ' + error.message);
        }
    }
    
    function displayWebsites() {
        const container = document.getElementById('websitesContainer');
        
        if (websites.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #666;">
                    <h3>No websites yet</h3>
                    <p>Create your first AI-powered website to get started!</p>
                    <a href="/create-website" class="btn btn-primary" style="margin-top: 20px;">
                        üöÄ Create First Website
                    </a>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <div class="grid">
                ${websites.map(website => `
                    <div class="website-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <h3>${website.title || 'Untitled Website'}</h3>
                            <span class="status-badge ${website.is_published ? 'status-published' : 'status-draft'}">
                                ${website.is_published ? 'üü¢ Published' : 'üü° Draft'}
                            </span>
                        </div>
                        
                        <div class="website-meta">
                            <p><strong>ID:</strong> <code style="font-size: 0.8em;">${website._id}</code></p>
                            <p><strong>Type:</strong> ${website.business_type || 'General'}</p>
                            <p><strong>Industry:</strong> ${website.industry || 'N/A'}</p>
                            <p><strong>Created:</strong> ${new Date(website.created_at).toLocaleDateString()}</p>
                            <p><strong>Last Updated:</strong> ${new Date(website.updated_at).toLocaleDateString()}</p>
                        </div>
                        
                        <div class="website-actions">
                            ${website.is_published ? 
                                `<a href="/api/preview/${website._id}" target="_blank" class="btn btn-success">üëÅÔ∏è View Live</a>` : 
                                '<span class="btn" style="opacity: 0.5; cursor: not-allowed;">üëÅÔ∏è Not Published</span>'
                            }
                            <button onclick="openEditModal('${website._id}')" class="btn btn-primary">‚úèÔ∏è Edit</button>
                            <button onclick="regenerateContent('${website._id}')" class="btn" style="background: #f39c12;">üîÑ Regenerate</button>
                            <button onclick="deleteWebsite('${website._id}')" class="btn btn-danger">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    function showError(message) {
        const container = document.getElementById('websitesContainer');
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #e74c3c;">
                <h3>Error</h3>
                <p>${message}</p>
                <button onclick="loadWebsites()" class="btn btn-primary" style="margin-top: 15px;">
                    üîÑ Try Again
                </button>
            </div>
        `;
    }
    
    // ONLY open modal when Edit button is clicked - NOT automatically
    function openEditModal(websiteId) {
        console.log('Opening edit modal for website:', websiteId);
        
        const website = websites.find(w => w._id === websiteId);
        if (!website) {
            alert('Website not found');
            return;
        }
        
        // Populate modal with website data
        document.getElementById('editWebsiteId').value = websiteId;
        document.getElementById('editTitle').value = website.title || '';
        document.getElementById('editPublished').value = website.is_published ? 'true' : 'false';
        document.getElementById('currentWebsiteId').textContent = websiteId;
        
        // Show the modal
        document.getElementById('editModal').classList.remove('hidden');
    }
    
    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
        
        // Clear form
        document.getElementById('editWebsiteId').value = '';
        document.getElementById('editTitle').value = '';
        document.getElementById('editPublished').value = 'false';
        document.getElementById('currentWebsiteId').textContent = '';
    }
    
    async function regenerateContent(websiteId) {
        if (!confirm('Regenerate content? This will replace all current content.')) {
            return;
        }
        
        try {
            const authToken = localStorage.getItem('auth_token');
            const response = await fetch(`/api/regenerate-content/${websiteId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                alert('Content regenerated successfully!');
                loadWebsites(); // Refresh the list
            } else {
                const error = await response.json();
                alert('Failed to regenerate content: ' + (error.error || response.statusText));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function deleteWebsite(websiteId) {
        if (!confirm('Delete this website? This cannot be undone.')) {
            return;
        }
        
        try {
            const authToken = localStorage.getItem('auth_token');
            const response = await fetch(`/api/websites/${websiteId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                alert('Website deleted successfully!');
                loadWebsites(); // Refresh the list
            } else {
                const error = await response.json();
                alert('Failed to delete website: ' + (error.error || response.statusText));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    // Handle form submission for editing
    document.getElementById('editWebsiteForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const websiteId = document.getElementById('editWebsiteId').value;
        const title = document.getElementById('editTitle').value.trim();
        const isPublished = document.getElementById('editPublished').value === 'true';
        
        if (!websiteId) {
            alert('Website ID is missing');
            return;
        }
        
        if (!title) {
            alert('Website title is required');
            return;
        }
        
        console.log('Updating website:', { websiteId, title, isPublished });
        
        try {
            const authToken = localStorage.getItem('auth_token');
            const response = await fetch(`/api/websites/${websiteId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: title,
                    is_published: isPublished
                })
            });
            
            console.log('Update response status:', response.status);
            
            if (response.ok) {
                alert('Website updated successfully!');
                closeEditModal();
                loadWebsites(); // Refresh the list to show updated data
            } else {
                const errorText = await response.text();
                console.error('Update failed:', errorText);
                alert('Failed to update website: ' + errorText);
            }
        } catch (error) {
            console.error('Update error:', error);
            alert('Error updating website: ' + error.message);
        }
    });
    
    // Close modal when clicking outside
    document.getElementById('editModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEditModal();
        }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeEditModal();
        }
    });
    
    // Initialize - Load websites when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded, loading websites...');
        loadWebsites();
    });
</script>
{% endblock %}